---
title: "Group project"
author: "Yun Zhu"
date: "28/02/2022"
output: pdf_document
---

```{r setup, include=FALSE}
library(haven)
library(naniar)
library(gtsummary)
library(pROC)
setwd("/Users/Crystal/Desktop/CHL5250/group project/")
frax_risk <- read_sas("frax_risk.sas7bdat", NULL)
frax_risk <-as.data.frame(frax_risk)
```

```{r check missing value}
# replace "don't know" with NA
dn9<-c("ALQ101","DBQ197","DBQ229","DIQ010","DIQ220","MCQ190","MCQ160C","OSQ010A","OSQ010B","OSQ010C","OSQ40AA","OSQ40BA","OSQ40CA","OSQ070","OSQ130","OSQ170","OSQ200")
dn999<-c("ALQ130","ALQ140Q","DID040")
dn9999<-c("OSQ020A","OSQ020B","OSQ020C","WHD020","WHD110","WHD140")
dn99999<-c("MCQ160A","MCQ180A","MCQ180C","MCQ160L","MCQ170L","MCQ180L")
frax_risk %>% replace_with_na_at(.vars= dn9, condition = ~.x == 9)
frax_risk %>% replace_with_na_at(.vars= dn999, condition = ~.x == 999)
frax_risk %>% replace_with_na_at(.vars= dn9999, condition = ~.x == 9999)
frax_risk %>% replace_with_na_at(.vars= dn99999, condition = ~.x == 99999)
# check missing values of all variables
gg_miss_var(frax_risk, show_pct = TRUE)
# pick variables with missing value proportion over 50%
frax_risk_missing<-frax_risk[, which(colMeans(is.na(frax_risk)) > 0.5)]
gg_miss_var(frax_risk_missing, show_pct = TRUE)
# summary table of variables with missing value
tbl_summary(frax_risk_missing)
# drop variables with missing value proportion over 80%:
# (1) 9 of 15 "OSQ" variables are dropped, "OSQ010A/B/C", "OSQ130","OSQ170" and "OSQ200" are still in the data set. 
# REMARK:"OSQ140Q/U" are not in the data description on the case study webpage, see https://www.icpsr.umich.edu/web/NACDA/studies/25505/datasets/0219/variables/OSQ140U?archive=NACDA for detail.
# (2) 2 of 3 diabetes related variables are dropped: "DID040" and "DIQ010".
# (3) 2 of 3 liver related variables are dropped: "MCQ180L" and "MCQ170L".
# (4) "MCQ180C" and "MCQ180L" have missing value over 80%, and "MCQ180A" has proportion nearly 75%, so drop them together.(less important variables)
# (5) drop "MCQ190" since it's hard to do imputation.
# (6) drop "SMQ040" too, since we still have "SMQ020" in the data set, and see https://www.icpsr.umich.edu/web/NACDA/studies/25505/datasets/0227/variables/SMQ040?archive=nacda for detail.
```

```{r}
frax_risk1<-frax_risk[, which(colMeans(!is.na(frax_risk)) > 0.2)]
gg_miss_var(frax_risk1, show_pct = TRUE)
table <- 
  tbl_summary(
    frax_risk1,
    by = RIAGENDR # split table by group
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p() %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels() 
table
```

```{r}
frax_risk_BMD<-select(frax_risk1,contains("BMD"))
BMD_variables<-colnames(frax_risk_BMD)
frax_risk1<-frax_risk1%>% mutate(fracture=as.factor(ifelse((OSQ010A=="1"|OSQ010B=="1"|OSQ010C=="1"), 1, 0)))
frax_risk_men<-frax_risk1%>%filter(RIAGENDR==1)
frax_risk_women<-frax_risk1%>%filter(RIAGENDR==2)
```

