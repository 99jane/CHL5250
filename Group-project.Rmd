---
title: "Group project"
author: "Yun Zhu"
date: "28/02/2022"
output: pdf_document
---

```{r setup, include=FALSE}
library(haven)
library(naniar)
library(gtsummary)
library(pROC)
library(dplyr)
setwd("/Users/Crystal/Desktop/CHL5250/group project/")
frax_risk <- read_sas("frax_risk.sas7bdat", NULL)
frax_risk <-as.data.frame(frax_risk)
```

```{r check missing value}
# replace "don't know" with NA
dn9<-c("ALQ101","DBQ197","DBQ229","DIQ010","DIQ220","MCQ190","MCQ160C","OSQ010A","OSQ010B","OSQ010C","OSQ40AA","OSQ40BA","OSQ40CA","OSQ070","OSQ130","OSQ170","OSQ200")
dn999<-c("ALQ130","ALQ140Q","DID040")
dn9999<-c("OSQ020A","OSQ020B","OSQ020C","WHD020","WHD110","WHD140")
dn99999<-c("MCQ160A","MCQ180A","MCQ180C","MCQ160L","MCQ170L","MCQ180L")
frax_risk[,dn9]<-na_if(frax_risk[,dn999],9)
frax_risk[,dn999]<-na_if(frax_risk[,dn999],999)
frax_risk[,dn9999]<-na_if(frax_risk[,dn999],9999)
frax_risk[,dn99999]<-na_if(frax_risk[,dn999],99999)
# check missing values of all variables
gg_miss_var(frax_risk, show_pct = TRUE)
# pick variables with missing value proportion over 50%
frax_risk_50<-frax_risk[, which(colMeans(is.na(frax_risk)) > 0.5)]
gg_miss_var(frax_risk_50, show_pct = TRUE)

# drop variables with missing value proportion over 50%:
# (1) 9 of 18 "OSQ" variables are dropped, "OSQ010A/B/C", "OSQ130","OSQ170" and "OSQ200" are still in the data set. 
# REMARK:"OSQ140Q/U" are not in the data description on the case study webpage, see https://www.icpsr.umich.edu/web/NACDA/studies/25505/datasets/0219/variables/OSQ140U?archive=NACDA for detail.
# (2) 1 of 3 diabetes related variables are dropped: "DID040" .
# (3) 1 of 3 weight related variables are dropped: "WHD140".
# (4) drop 1 variable related to liver, coronary heart disease and arthritis separately: "MCQ"
# (5) drop "MCQ190"?? MCQ variables need to be inspected more...
# (6) drop "DBQ229" too, since we still have "DBQ197" in the data set.
# (7) drop "SMQ040" too, since we still have "SMQ020" in the data set, and see https://www.icpsr.umich.edu/web/NACDA/studies/25505/datasets/0227/variables/SMQ040?archive=nacda for detail.
```

```{r check variables with missing value less than 50%}
# missing value more than 20%
frax_risk_2050<-frax_risk[, which((colMeans(is.na(frax_risk)) <= 0.5)&(colMeans(is.na(frax_risk)) > 0.2))]
gg_miss_var(frax_risk_2050, show_pct = TRUE)
length(frax_risk_2050)
# 32 variables need imputation?

# missing value less than 20%
frax_risk_20<-frax_risk[, which(colMeans(is.na(frax_risk)) <= 0.2)]
gg_miss_var(frax_risk_20, show_pct = TRUE)
# keep all these variables, don't need imputation.
```

```{r dataframe}
# create a data frame 
df<-frax_risk[, which(colMeans(is.na(frax_risk)) <= 0.5)]
```

```{r}
frax_risk1<-frax_risk[, which(colMeans(!is.na(frax_risk)) > 0.2)]
gg_miss_var(frax_risk1, show_pct = TRUE)
table <- 
  tbl_summary(
    frax_risk1,
    by = RIAGENDR # split table by group
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p() %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels() 
table
```

```{r}
frax_risk_BMD<-select(frax_risk1,contains("BMD"))
BMD_variables<-colnames(frax_risk_BMD)
frax_risk1<-frax_risk1%>% mutate(fracture=as.factor(ifelse((OSQ010A=="1"|OSQ010B=="1"|OSQ010C=="1"), 1, 0)))
frax_risk_men<-frax_risk1%>%filter(RIAGENDR==1)
frax_risk_women<-frax_risk1%>%filter(RIAGENDR==2)
```

